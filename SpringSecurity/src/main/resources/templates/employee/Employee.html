<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
	<title>Altrocks | Employee Creation</title>
	<div th:replace="fragments/Common-topnav :: head"></div>

	<!-- Required CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
</head>

<style>
	.select2-container .select2-selection--single {
		height: 38px !important;
		/* or match Bootstrap input height */
		padding: 6px 12px;
	}

	.select2-selection__rendered {
		line-height: 24px;
	}

	.select2-selection__arrow {
		height: 36px !important;
	}
</style>


<body class="hold-transition layout-top-nav">
	<div class="wrapper">
		<div th:replace="fragments/Common-topnav :: navbar"></div>

		<div class="content-wrapper diplayimg">
			<div class="content-header">
				<div class="container">
					<div class="row mb-2 align-items-center">
						<div class="col-sm-6">
							<h1 class="m-0">
								<img src="/dist/img/doc.png" alt="doc icon"> Employee Creation
							</h1>
						</div>
						<div class="col-sm-6 text-right">
							<!-- ✅ Button to load employee list -->
							<button class="btn btn-primary" onclick="loadEmployeeList()">View Employee List</button>
						</div>
					</div>
				</div>
			</div>

			<div class="content">
				<div class="container">

					<!-- EMPLOYEE CREATE SECTION -->
					<div class="card shadow mb-4">
						<div class="card-header  text-black font-weight-bold">Create Employee</div>
						<div class="card-body">
							<form id="employeeForm">
								<div class="form-row">
									<div class="form-group col-md-3">
										<label>User Name:</label>
										<select name="username" id="username" class="form-control select2" required>
											<option></option>
											<option value="john.doe">john.doe</option>
											<option value="jane.smith">jane.smith</option>
										</select>
									</div>

									<div class="form-group col-md-3">
										<label>User Email</label>
										<input type="email" class="form-control" id="useremail" placeholder="Free text">
									</div>
									<div class="form-group col-md-3">
										<label>Password <span class="text-danger">(M)</span></label>
										<input type="password" class="form-control" id="password"
											placeholder="Setup in portal">
									</div>
									<div class="form-group col-md-3">
										<label>Role</label>
										<select class="form-control select2" id="role" name="roleId" required>
											<option></option>
											<th:block th:each="r : ${roles}">
												<option th:value="${r.id}" th:text="${r.roleName}"></option>
											</th:block>
										</select>


									</div>

								</div>

								<div class="form-row">
									<div class="form-group col-md-4">
										<label>Email (Login)</label>
										<input type="email" class="form-control" id="loginemail"
											placeholder="Enter Email">
									</div>
									<div class="form-group col-md-4">
										<label>Location</label>
										<select class="form-control select2" id="location">
											<option></option>
											<option>Hyderabad</option>
											<option>Bangalore</option>
											<option>Mumbai</option>
										</select>
									</div>
									<div class="form-group col-md-4">
										<label>Department</label>
										<select class="form-control select2" id="department">
											<option></option>
											<option>IT</option>
											<option>HR</option>
											<option>Finance</option>
										</select>
									</div>
								</div>

								<div class="text-right">
									<button type="button" class="btn btn-success" onclick="createUser()">Create
										User</button>
								</div>
							</form>
						</div>
					</div>

					<!-- VIEW SECTION -->
					<div class="card shadow mb-4" id="view-section" style="display: none;">
						<div class="card-header  text-black font-weight-bold">View Employee Details</div>
						<div class="card-body">
							<table class="table table-bordered table-sm">
								<thead>
									<tr>
										<th>User Name</th>
										<th>User Email</th>
										<th>Role</th>
										<th>Login Email</th>
										<th>Location</th>
										<th>Department</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody id="userTableBody"></tbody>
							</table>
						</div>
					</div>


					<div class="modal fade" id="editModal" tabindex="-1" role="dialog">
						<div class="modal-dialog modal-lg" role="document">
							<div class="modal-content">
								<div class="modal-header text-black">
									<h5 class="modal-title">Edit Employee</h5>
									<button type="button" class="close text-white" data-dismiss="modal">
										<span>&times;</span>
									</button>
								</div>
								<div class="modal-body">
									<input type="hidden" id="edit-index" />

									<!-- First row -->
									<div class="form-row">
										<div class="form-group col-md-4">
											<label>User Name:</label>
											<select id="edit-username" class="form-control select2"
												style="width: 100%;">
												<option></option>
												<option value="john.doe">john.doe</option>
												<option value="jane.smith">jane.smith</option>
											</select>
										</div>

										<div class="form-group col-md-4">
											<label>User Email</label>
											<input type="email" class="form-control" id="edit-email" disabled />
										</div>

										<div class="form-group col-md-4">
											<label>Password</label>
											<input type="password" class="form-control" id="edit-password"
												placeholder="Change password">
										</div>
									</div>

									<!-- Second row -->
									<div class="form-row">
										<div class="form-group col-md-4">
											<label>Role</label>
											<select class="form-control select2" id="edit-role" name="roleId" required>

												<option></option>
												<th:block th:each="r : ${roles}">
													<option th:value="${r.id}" th:text="${r.roleName}"></option>
												</th:block>
											</select>
										</div>

										<div class="form-group col-md-4">
											<label>Email (Login)</label>
											<input type="email" class="form-control" id="edit-loginemail" />
										</div>

										<div class="form-group col-md-4">
											<label>Location</label>
											<select class="form-control select2" id="edit-location"
												style="width: 100%;">
												<option></option>
												<option>Hyderabad</option>
												<option>Bangalore</option>
												<option>Mumbai</option>
											</select>
										</div>
									</div>

									<!-- Third row -->
									<div class="form-row">
										<div class="form-group col-md-4">
											<label>Department</label>
											<select class="form-control select2" id="edit-department"
												style="width: 100%;">
												<option></option>
												<option>IT</option>
												<option>HR</option>
												<option>Finance</option>
											</select>
										</div>
									</div>
								</div>

								<div class="modal-footer">
									<button class="btn btn-success" onclick="updateUser()">Update</button>
									<button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
								</div>
							</div>
						</div>
					</div>



				</div> <!-- container -->
			</div> <!-- content -->
		</div> <!-- content-wrapper -->
	</div>

	<!-- Required JS -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

	<script>
		let editingRow = null;

		function createUser() {
			const roleDropdown = document.getElementById("role");
			const selectedRoleName = roleDropdown.options[roleDropdown.selectedIndex].text;

			const user = {
				username: document.getElementById("username").value,
				useremail: document.getElementById("useremail").value,
				password: document.getElementById("password").value,
				roleId: roleDropdown.value,
				loginemail: document.getElementById("loginemail").value,
				location: document.getElementById("location").value,
				department: document.getElementById("department").value
			};

			if (!user.username || !user.password || !user.roleId || !user.loginemail) {
				Swal.fire('Error', 'Please fill all mandatory fields', 'warning');
				return;
			}

			fetch("/capex/sterling/employee/save", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(user)
			})
			.then(async response => {
				const message = await response.text();
				if (!response.ok) {
					throw new Error(message);
				}

				Swal.fire("Success", message, "success");
				document.getElementById("view-section").style.display = "block";

				const table = document.getElementById("userTableBody");
				const row = document.createElement("tr");
				row.innerHTML = `
					<td>${user.username}</td>
					<td>${user.useremail}</td>
					<td>${selectedRoleName}</td>
					<td>${user.loginemail}</td>
					<td>${user.location}</td>
					<td>${user.department}</td>
					<td><button class="btn btn-sm btn-primary" onclick="editUser(this)">Edit</button></td>
				`;
				table.appendChild(row);

				document.getElementById("employeeForm").reset();
				$('#username, #role, #location, #department').val(null).trigger('change');
			})
			.catch(error => {
				console.error("Error:", error);
				Swal.fire("Error", error.message, "error");
			});
		}

		function loadEmployeeList() {
			fetch("/capex/sterling/employee/list")
				.then(response => response.json())
				.then(data => {
					const tbody = document.getElementById("userTableBody");
					tbody.innerHTML = ""; // clear existing rows

					data.forEach(emp => {
						const row = document.createElement("tr");
						row.innerHTML = `
							<td>${emp.username}</td>
							<td>${emp.useremail}</td>
							<td>${emp.role}</td>
							<td>${emp.loginemail}</td>
							<td>${emp.location}</td>
							<td>${emp.department}</td>
							<td><button class="btn btn-sm btn-primary" onclick="editUser(this)">Edit</button></td>
						`;
						tbody.appendChild(row);
					});

					document.getElementById("view-section").style.display = "block";
				})
				.catch(error => {
					console.error("Error fetching employee list:", error);
					Swal.fire("Error", "Unable to fetch employee list", "error");
				});
		}




		function editUser(button) {
			const row = button.closest("tr");
			const cells = row.getElementsByTagName("td");
			editingRow = row;

			$('#edit-username').val(cells[0].innerText).trigger('change');
			$('#edit-email').val(cells[1].innerText);
			$('#edit-role').val(cells[2].innerText).trigger('change');
			$('#edit-loginemail').val(cells[3].innerText);
			$('#edit-location').val(cells[4].innerText).trigger('change');
			$('#edit-department').val(cells[5].innerText).trigger('change');

			$('#editModal').modal('show');
		}
		function updateUser() {
			const selectedRoleDropdown = document.getElementById("edit-role");
			const selectedRoleName = selectedRoleDropdown.options[selectedRoleDropdown.selectedIndex].text;

			const updatedUser = {
				username: $('#edit-username').val(),
				useremail: $('#edit-email').val(),
				password: $('#edit-password').val(),
				role: $('#edit-role').val(), // Send role ID
				loginemail: $('#edit-loginemail').val(),
				location: $('#edit-location').val(),
				department: $('#edit-department').val()
			};

			fetch("/capex/sterling/employee/update", {
				method: "PUT",
				headers: {"Content-Type": "application/json"},
				body: JSON.stringify(updatedUser)
			})
				.then(res => {
					if (!res.ok) throw new Error("Failed to update user");
					return res.text();
				})
				.then(() => {
					Swal.fire({icon: 'success', title: 'Updated!'});
					$('#editModal').modal('hide');

					if (editingRow) {
						const cells = editingRow.getElementsByTagName("td");
						cells[0].innerText = updatedUser.username;
						cells[1].innerText = updatedUser.useremail;
						cells[2].innerText = selectedRoleName; // ✅ Correct role name from modal
						cells[3].innerText = updatedUser.loginemail;
						cells[4].innerText = updatedUser.location;
						cells[5].innerText = updatedUser.department;
					}
					editingRow = null;
				})
				.catch(error => {
					console.error("Error:", error);
					Swal.fire("Error", "Failed to update user", "error");
				});
		}


		$(document).ready(function () {
			$('#username,#role,#location,#department').select2({
				placeholder: "Select option",
				allowClear: true
			});
		});
		$(document).ready(function () {
			// Initialize all select2 fields including edit modal
			$('#username, #role, #location, #department, #edit-username, #edit-role, #edit-location, #edit-department').select2({
				placeholder: "Select option",
				allowClear: true,
				width: '100%' // Ensure full width
			});
		});



	</script>

	<div th:replace="fragments/Common-topnav :: footer"></div>
</body>

</html>